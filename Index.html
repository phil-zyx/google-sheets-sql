<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets SQL</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.3/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.3/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
            body {
            padding: 20px;
            font-family: Arial, sans-serif;
            height: 100vh;
            margin: 0;
        }
        
        .container-fluid {
            height: calc(100vh - 40px);
            /* 减去body的padding */
            display: flex;
            flex-direction: column;
        }
        
        .header {
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        
        .row {
            flex: 1;
            min-height: 0;
            /* 重要：允许内容收缩 */
        }
        
        .nav-tabs {
            margin-bottom: 15px;
        }
        
        .sheet-list {
            height: calc(100vh - 400px);
            /* 动态高度 */
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .code-editor {
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .CodeMirror {
            height: calc(25vh);
            /* 动态高度 */
            font-size: 14px;
        }
        
        .result-container {
            height: calc(45vh);
            /* 动态高度 */
            overflow: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }
        
        .result-table {
            width: 100%;
        }
        
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
            margin-right: 5px;
        }
        
        @keyframes spinner-border {
            to {
                transform: rotate(360deg);
            }
        }
        
        .example-queries {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .example-query {
            cursor: pointer;
            margin-bottom: 5px;
            color: #0d6efd;
        }
        
        .tree-view {
            margin-bottom: 20px;
        }
        
        .tree-item {
            margin-left: 20px;
        }
        
        .sheet-name {
            font-weight: bold;
            cursor: pointer;
        }
        /* 更新表名样式 - 使用蓝紫色 */
        
        .worksheet-name {
            cursor: pointer;
            color: #5C7CFA;
            /* 蓝紫色 */
            display: flex;
            align-items: center;
        }
        
        .worksheet-name:hover {
            text-decoration: underline;
            color: #364FC7;
            /* 深蓝色 */
        }
        
        .worksheet-name::before {
            .query-history-item:hover {
                background-color: #f8f9fa;
            }
            .history-timestamp {
                font-size: 0.8em;
                color: #6c757d;
            }
            .history-query {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .stats-panel {
                font-size: 0.9em;
                margin-top: 10px;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 5px;
            }
            .stats-item {
                display: inline-block;
                margin-right: 15px;
                margin-bottom: 5px;
            }
            /* 添加一个分隔线样式 */
            .timing-details {
                margin-top: 5px;
                padding-top: 5px;
                border-top: 1px solid #dee2e6;
            }
            /* 添加响应式布局支持 */
            @media (max-width: 768px) {
                .container-fluid {
                    height: auto;
                }
                .sheet-list,
                .metadata-tree {
                    height: 300px;
                }
                .CodeMirror {
                    height: 200px;
                }
                .result-container {
                    height: 300px;
                }
            }
            .template-name {
                cursor: pointer;
                color: #0d6efd;
            }
            .template-name:hover {
                text-decoration: underline;
            }
            #previewSql {
                max-height: 200px;
                overflow: auto;
                white-space: pre-wrap;
                font-size: 0.9em;
            }
            /* 验证相关样式 */
            .validation-controls {
                margin-bottom: 15px;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 5px;
            }
            .validation-error {
                color: #dc3545;
            }
            .validation-success {
                color: #198754;
            }
            .validation-summary {
                margin-top: 10px;
                padding: 10px;
                border-radius: 5px;
            }
            /* 添加悬停提示样式 */
            tr.table-danger:hover {
                background-color: #f8d7da;
                cursor: help;
            }
            .public-template-card {
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .public-template-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            .public-template-card .template-name {
                color: #0d6efd;
                cursor: pointer;
            }
            .public-template-card .template-name:hover {
                text-decoration: underline;
            }
            .rating-stars {
                display: flex;
                justify-content: center;
                margin-bottom: 10px;
            }
            .btn-outline-warning:not(.active):hover {
                background-color: transparent;
                color: #ffc107;
            }
            .btn-check:checked+.btn-outline-warning {
                background-color: #ffc107;
                border-color: #ffc107;
                color: #000;
            }
            /* Add to the CSS section */
            .column-name {
                cursor: pointer;
                color: #0d6efd;
                display: inline-block;
                margin-right: 3px;
            }
            .column-name:hover {
                text-decoration: underline;
            }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="header">
            <h1>Google Sheets SQL</h1>
            <div class="d-flex justify-content-between">
                <p>基于 Google Apps Scripts + AlaSQL 的查询工具</p>
                <a data-nav-link="help" data-target="_blank" href="#" class="btn btn-sm btn-outline-info">
                    <i class="bi bi-question-circle"></i> 帮助文档
                </a>
                <a data-nav-link="check" href="#" class="btn btn-primary">配置检查工作流</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <!-- 侧边栏导航 -->
                <ul class="nav nav-tabs" id="sidebarTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="sheets-tab" data-bs-toggle="tab" data-bs-target="#sheets-panel" type="button" role="tab">
                            配置表
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates-panel" type="button" role="tab">
                            个人模板
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-panel" type="button" role="tab">
                            历史记录
                        </button>
                    </li>
                </ul>

                <!-- 侧边栏内容 -->
                <div class="tab-content" id="sidebarContent">
                    <!-- 工作表面板 -->
                    <div class="tab-pane fade show active" id="sheets-panel" role="tabpanel">
                        <h5>可用的工作表</h5>
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" id="sheetSearchInput" placeholder="搜索表..." oninput="filterSheets()">
                        </div>
                        <div id="sheetList" class="sheet-list">
                            <div class="spinner"></div> 加载中...
                        </div>

                        <div class="example-queries">
                            <h5>示例查询</h5>
                            <div class="example-query" onclick="setExampleQuery(1)">查询单个工作表</div>
                            <div class="example-query" onclick="setExampleQuery(2)">联表查询</div>
                            <div class="example-query" onclick="setExampleQuery(3)">JSON 字段解析</div>
                            <div class="example-query" onclick="setExampleQuery(4)">聚合查询</div>
                        </div>
                    </div>

                    <!-- 模板面板 -->
                    <div class="tab-pane fade" id="templates-panel" role="tabpanel">
                        <h5>SQL 模板</h5>
                        <div id="templateList" class="sheet-list">
                            <p>没有保存的模板</p>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <button class="btn btn-sm btn-primary" onclick="saveTemplateModal()">保存当前查询为模板</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshTemplates()">刷新</button>
                        </div>
                    </div>

                    <!-- 历史记录面板 -->
                    <div class="tab-pane fade" id="history-panel" role="tabpanel">
                        <h5>查询历史</h5>
                        <div id="queryHistory" class="sheet-list">
                            <p>没有查询历史记录</p>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearQueryHistory()">清空历史记录</button>
                    </div>

                    <!-- 公共模板面板 -->
                    <div class="tab-pane fade" id="public-templates-panel" role="tabpanel">
                        <h5>公共模板库</h5>
                        <div id="publicTemplateList" class="sheet-list">
                            <p>点击加载公共模板...</p>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <button class="btn btn-sm btn-primary" onclick="submitPublicTemplateModal()">贡献模板</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadPublicTemplates()">刷新</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <h4>SQL 查询</h4>
                <div class="code-editor" id="editorContainer"></div>

                <div class="mb-3">
                    <label for="validationRules" class="form-label">验证规则</label>
                    <textarea id="validationRules" class="form-control" rows="2" placeholder="输入验证规则，例如：列名1 = 列名2 或 列名 > 0"></textarea>
                    <div class="form-text">每行一条规则，您可以使用比较运算符：=, !=, >, >=,
                        <, <=</div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showErrorsOnly">
                        <label class="form-check-label" for="showErrorsOnly">
                        仅显示错误行
                    </label>
                    </div>

                    <div class="d-flex justify-content-between mb-3">
                        <div>
                            <button class="btn btn-primary" onclick="executeQuery()">
                            <i class="bi bi-play-fill"></i> 执行查询
                        </button>
                            <button class="btn btn-outline-secondary" onclick="formatSQL()">
                            <i class="bi bi-text-indent-left"></i> 格式化
                        </button>
                        </div>
                        <div>
                            <button class="btn btn-outline-danger" onclick="clearResults()">
                            <i class="bi bi-x-circle"></i> 清空结果
                        </button>
                        </div>
                    </div>

                    <h4>查询结果 <span id="resultCount" class="badge bg-secondary"></span></h4>
                    <div id="loading" style="display: none;">
                        <div class="spinner"></div> 执行查询中...
                    </div>

                    <div id="statsPanel" class="stats-panel" style="display: none;">
                        <div>
                            <div class="stats-item">
                                <i class="bi bi-clock"></i> 总执行时间: <span id="executionTime">0</span> ms
                            </div>
                            <div class="stats-item">
                                <i class="bi bi-table"></i> 结果行数: <span id="rowCount">0</span>
                            </div>
                            <!-- 详细计时信息将动态添加到这里 -->
                        </div>
                    </div>

                    <div id="resultContainer" class="result-container">
                        <div id="resultTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.3/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.3/mode/sql/sql.min.js"></script>

        <script>
            let editor;
            let allSheets = [];
            let sheetDataCache = {};
            const QUERY_HISTORY_KEY = 'google_sheets_sql_history';
            const MAX_HISTORY_ITEMS = 20;

            // 初始化编辑器
            function initEditor() {
                editor = CodeMirror(document.getElementById('editorContainer'), {
                    mode: 'text/x-sql',
                    theme: 'dracula',
                    lineNumbers: true,
                    indentWithTabs: true,
                    smartIndent: true,
                    lineWrapping: true,
                    extraKeys: {
                        'Ctrl-Enter': executeQuery,
                        'Cmd-Enter': executeQuery,
                        'Ctrl-S': saveQuery,
                        'Cmd-S': saveQuery
                    }
                });

                // 设置默认查询
                editor.setValue("-- 在此输入 SQL 查询\n-- 例如: SELECT * FROM filename.sheetname LIMIT 10");
            }

            // 加载所有工作表
            function loadSheets() {
                document.getElementById('sheetList').innerHTML = '<div class="spinner"></div> 加载中...';

                google.script.run
                    .withSuccessHandler(displaySheets)
                    .withFailureHandler(handleError)
                    .getAllSheetsForClient();
            }

            // 显示工作表列表
            function displaySheets(sheets) {
                allSheets = sheets;
                const sheetListEl = document.getElementById('sheetList');

                if (sheets.length === 0) {
                    sheetListEl.innerHTML = '<p>没有找到可访问的工作表</p>';
                    return;
                }

                let html = '<div class="tree-view">';

                sheets.forEach(sheet => {
                    html += `
          <div>
            <div class="sheet-name" onclick="toggleSheetDetails('${sheet.id}')">
              <i class="bi bi-file-earmark-spreadsheet"></i> ${sheet.name}
            </div>
            <div id="sheet-${sheet.id}" class="tree-item" style="display:none;"></div>
          </div>
        `;
                });

                html += '</div>';
                sheetListEl.innerHTML = html;
            }

            // 切换显示工作表详情
            function toggleSheetDetails(fileId) {
                const detailsElement = document.getElementById(`sheet-${fileId}`);

                if (detailsElement.innerHTML === '') {
                    // 加载工作表详情
                    detailsElement.innerHTML = '<div class="spinner"></div> 加载中...';
                    detailsElement.style.display = 'block';

                    loadSheetDetails(fileId);
                } else {
                    // 切换显示/隐藏
                    detailsElement.style.display = detailsElement.style.display === 'none' ? 'block' : 'none';
                }
            }

            // 加载工作表详情
            function loadSheetDetails(fileId) {
                if (sheetDataCache[fileId]) {
                    displaySheetDetails(fileId, sheetDataCache[fileId]);
                    return;
                }

                google.script.run
                    .withSuccessHandler(function(data) {
                        sheetDataCache[fileId] = data;
                        displaySheetDetails(fileId, data);
                    })
                    .withFailureHandler(handleError)
                    .getSheetMetadata(fileId);
            }

            // 显示工作表详情
            function displaySheetDetails(fileId, data) {
                const detailsElement = document.getElementById(`sheet-${fileId}`);
                const sheetName = allSheets.find(s => s.id === fileId).name;

                if (!data || !data.sheets) {
                    detailsElement.innerHTML = '<p>无法获取工作表详情</p>';
                    return;
                }

                let html = '';

                // 显示工作表名称和第一个页签的表头
                data.sheets.forEach((sheet, index) => {
                            html += `
                    <div>
                        <div class="worksheet-name" onclick="insertTableName('${sheetName}.${sheet.name}')">
                            ${sheet.name}
                        </div>`;

                            // 如果是第一个页签且有表头信息，显示表头
                            if (index === 0 && data.firstHeaders && data.firstHeaders.length > 0) {
                                html += `
                        <div class="tree-item">
                            <small>列: ${data.firstHeaders.map(header => 
                                `<span class="column-name" onclick="insertColumnName('${header}')">${header}</span>`
                            ).join(', ')}</small>
                        </div>`;
                    }

                    html += `</div>`;
                });

                detailsElement.innerHTML = html;
            }

            // 在编辑器中插入表名
            function insertTableName(fullName) {
                const cursorPos = editor.getCursor();
                editor.replaceRange(fullName, cursorPos);
                editor.focus();
            }

            // 在编辑器中插入列名
            function insertColumnName(columnName) {
                const cursorPos = editor.getCursor();
                editor.replaceRange(columnName, cursorPos);
                editor.focus();
            }

            // 执行查询
            function executeQuery() {
                const sql = editor.getValue().trim();
                // 获取验证规则
                const validationRulesText = document.getElementById('validationRules').value;
                const validationRules = validationRulesText.split('\n').filter(line => line.trim());

                // if (!sql || sql.startsWith('--')) {
                //     alert('请输入有效的 SQL 查询');
                //     return;
                // }

                document.getElementById('loading').style.display = 'block';
                document.getElementById('resultTable').innerHTML = '';
                document.getElementById('resultCount').textContent = '';
                document.getElementById('statsPanel').style.display = 'none';

                // 修改这里，将验证规则作为参数传递
                google.script.run
                    .withSuccessHandler(displayResults)
                    .withFailureHandler(handleError)
                    .executeSQLWithValidation(sql, {}, validationRules);

                // 添加到查询历史
                addToQueryHistory(sql);
            }

            // 显示查询结果
            function displayResults(response) {
                document.getElementById('loading').style.display = 'none';

                // 处理有统计数据的响应格式
                let results = response;
                let stats = null;
                let validation = null;

                if (response && response.data !== undefined && response.stats !== undefined) {
                    results = response.data;
                    stats = response.stats;
                    validation = response.validation || null;

                    // 显示统计信息
                    displayStats(stats);
                }

                if (results && results.error) {
                    document.getElementById('resultTable').innerHTML = `
          <div class="alert alert-danger">
            <strong>错误:</strong> ${results.error}
          </div>
        `;
                    return;
                }

                if (!Array.isArray(results) || results.length === 0) {
                    document.getElementById('resultTable').innerHTML = '<p>查询没有返回结果</p>';
                    document.getElementById('resultCount').textContent = '0 条记录';
                    return;
                }

                // 显示验证结果摘要，如果有验证信息
                if (validation) {
                    const validationSummaryEl = document.getElementById('validationSummary') ||
                        createValidationSummaryElement();

                    if (validation.errorRows > 0) {
                        validationSummaryEl.className = 'alert alert-danger mb-3';
                        validationSummaryEl.innerHTML = `
                          <strong>验证失败:</strong> ${validation.errorRows}/${validation.totalRows} 行不符合验证规则
                        `;
                    } else {
                        validationSummaryEl.className = 'alert alert-success mb-3';
                        validationSummaryEl.innerHTML = `
                          <strong>验证通过:</strong> 所有 ${validation.totalRows} 行数据都符合验证规则
                        `;
                    }

                    validationSummaryEl.style.display = 'block';
                }

                // 检查是否仅显示错误行
                const showErrorsOnly = document.getElementById('showErrorsOnly').checked;

                document.getElementById('resultCount').textContent = `${results.length} 条记录`;

                // 获取所有列
                const columns = Object.keys(results[0]).filter(col => !col.startsWith('_validation'));

                // 创建表格
                let tableHtml = '<table class="table table-striped table-bordered result-table">';

                // 表头
                tableHtml += '<thead><tr>';
                columns.forEach(column => {
                    tableHtml += `<th>${column}</th>`;
                });
                tableHtml += '</tr></thead>';

                // 表体
                tableHtml += '<tbody>';
                results.forEach(row => {
                    // 如果仅显示错误行且当前行有效，则跳过
                    if (showErrorsOnly && row._validationStatus !== 'invalid') {
                        return;
                    }

                    // 设置行样式，错误行使用红色背景
                    const rowClass = row._validationStatus === 'invalid' ? 'table-danger' : '';
                    tableHtml += `<tr class="${rowClass}">`;

                    columns.forEach(column => {
                        const value = row[column];
                        let displayValue;

                        if (value === null || value === undefined) {
                            displayValue = '<em>null</em>';
                        } else if (typeof value === 'object') {
                            displayValue = JSON.stringify(value);
                        } else {
                            displayValue = value.toString();
                        }

                        tableHtml += `<td>${displayValue}</td>`;
                    });

                    // 如果行有错误，添加错误提示
                    if (row._validationStatus === 'invalid' && row._validationErrors) {
                        const errorMessages = row._validationErrors.map(e => e.message).join('<br>');
                        tableHtml += `<td class="table-danger" title="${errorMessages}">
                                        <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                      </td>`;
                    }

                    tableHtml += '</tr>';
                });

                tableHtml += '</tbody></table>';

                document.getElementById('resultTable').innerHTML = tableHtml;
            }

            // 创建验证摘要元素
            function createValidationSummaryElement() {
                const el = document.createElement('div');
                el.id = 'validationSummary';
                el.className = 'alert mb-3';
                el.style.display = 'none';

                // 插入到结果容器之前
                const resultContainer = document.getElementById('resultContainer');
                resultContainer.parentNode.insertBefore(el, resultContainer);

                return el;
            }

            // 显示统计信息
            function displayStats(stats) {
                if (!stats) return;

                // 显示统计面板
                document.getElementById('statsPanel').style.display = 'block';

                // 显示基本统计信息
                document.getElementById('rowCount').textContent = stats.rowCount || 0;
                document.getElementById('executionTime').textContent = stats.executionTime || 0;

                // 如果有详细的时间分解，创建更丰富的显示
                if (stats.timings) {
                    // 创建或更新详细计时信息DOM元素
                    let detailsHtml = `
                    <div class="mt-2">
                        <div class="stats-item"><i class="bi bi-hdd"></i> 表加载: ${stats.timings.tableLoading} ms</div>
                        <div class="stats-item"><i class="bi bi-lightning"></i> SQL执行: ${stats.timings.execution} ms</div>
                        <div class="stats-item"><i class="bi bi-brush"></i> 结果格式化: ${stats.timings.formatting} ms</div>
                        <div class="stats-item"><i class="bi bi-gear"></i> 初始化: ${stats.timings.initialization} ms</div>
                    </div>
                `;

                    // 检查是否已存在详细计时元素
                    let detailsElement = document.getElementById('timingDetails');
                    if (!detailsElement) {
                        // 如果不存在，创建新元素
                        const detailsDiv = document.createElement('div');
                        detailsDiv.id = 'timingDetails';
                        detailsDiv.innerHTML = detailsHtml;
                        document.getElementById('statsPanel').appendChild(detailsDiv);
                    } else {
                        // 更新现有元素
                        detailsElement.innerHTML = detailsHtml;
                    }
                }

                // 如果有SQL显示
                if (stats.sql) {
                    // 可以选择是否显示原始SQL，这取决于您的需求
                    console.log("执行的SQL: ", stats.sql);
                }
            }

            // 清空结果
            function clearResults() {
                document.getElementById('resultTable').innerHTML = '';
                document.getElementById('resultCount').textContent = '';
                document.getElementById('statsPanel').style.display = 'none';
            }

            // 格式化 SQL
            function formatSQL() {
                const sql = editor.getValue().trim();

                if (!sql) {
                    return;
                }

                try {
                    // 简单的 SQL 格式化
                    let formatted = sql
                        .replace(/\s+/g, ' ')
                        .replace(/\s*,\s*/g, ', ')
                        .replace(/\(\s+/g, '(')
                        .replace(/\s+\)/g, ')')
                        .replace(/\s+FROM/gi, '\nFROM')
                        .replace(/\s+WHERE/gi, '\nWHERE')
                        .replace(/\s+GROUP\s+BY/gi, '\nGROUP BY')
                        .replace(/\s+HAVING/gi, '\nHAVING')
                        .replace(/\s+ORDER\s+BY/gi, '\nORDER BY')
                        .replace(/\s+LIMIT/gi, '\nLIMIT')
                        .replace(/\s+JOIN/gi, '\nJOIN')
                        .replace(/\s+LEFT\s+JOIN/gi, '\nLEFT JOIN')
                        .replace(/\s+RIGHT\s+JOIN/gi, '\nRIGHT JOIN')
                        .replace(/\s+INNER\s+JOIN/gi, '\nINNER JOIN')
                        .replace(/\s+UNION/gi, '\nUNION');

                    editor.setValue(formatted);
                } catch (e) {
                    // 忽略格式化错误
                    console.error('格式化 SQL 失败:', e);
                }
            }

            // 查询历史相关
            function loadQueryHistory() {
                const history = JSON.parse(localStorage.getItem(QUERY_HISTORY_KEY) || '[]');
                displayQueryHistory(history);
            }

            function addToQueryHistory(sql) {
                const history = JSON.parse(localStorage.getItem(QUERY_HISTORY_KEY) || '[]');

                // 添加新查询到历史
                history.unshift({
                    sql: sql,
                    timestamp: new Date().toISOString()
                });

                // 保持历史记录数量在限制之内
                while (history.length > MAX_HISTORY_ITEMS) {
                    history.pop();
                }

                // 保存到本地存储
                localStorage.setItem(QUERY_HISTORY_KEY, JSON.stringify(history));

                // 更新显示
                displayQueryHistory(history);
            }

            function displayQueryHistory(history) {
                const historyEl = document.getElementById('queryHistory');

                if (!history || history.length === 0) {
                    historyEl.innerHTML = '<p>没有查询历史记录</p>';
                    return;
                }

                let html = '';

                history.forEach((item, index) => {
                    // 格式化日期时间
                    const date = new Date(item.timestamp);
                    const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

                    // 截断长查询
                    let displaySql = item.sql;
                    if (displaySql.length > 50) {
                        displaySql = displaySql.substring(0, 50) + '...';
                    }

                    html += `
          <div class="query-history-item" onclick="loadHistoryQuery(${index})">
            <div class="history-query">${displaySql}</div>
            <div class="history-timestamp">${formattedDate}</div>
          </div>
        `;
                });

                historyEl.innerHTML = html;
            }

            function loadHistoryQuery(index) {
                const history = JSON.parse(localStorage.getItem(QUERY_HISTORY_KEY) || '[]');

                if (history.length > index) {
                    editor.setValue(history[index].sql);
                    editor.focus();
                }
            }

            function clearQueryHistory() {
                if (confirm('确定要清空所有查询历史记录吗？')) {
                    localStorage.removeItem(QUERY_HISTORY_KEY);
                    document.getElementById('queryHistory').innerHTML = '<p>没有查询历史记录</p>';
                }
            }

            // 保存查询（快捷键响应）
            function saveQuery() {
                const sql = editor.getValue().trim();

                if (!sql) {
                    return;
                }

                // 简单地保存到历史记录中
                addToQueryHistory(sql);

                // 显示提示
                alert('查询已保存到历史记录');

                return false; // 阻止默认行为
            }

            // 设置示例查询
            function setExampleQuery(example) {
                let query = '';

                switch (example) {
                    case 1:
                        query = '-- 查询单个工作表\nSELECT * FROM filename.sheetname LIMIT 10';
                        break;
                    case 2:
                        query = '-- 联表查询\nSELECT a.*, b.column3\nFROM file1.sheet1 a\nJOIN file2.sheet2 b ON a.id = b.id\nWHERE a.column1 > 100\nORDER BY a.column2 DESC\nLIMIT 20';
                        break;
                    case 3:
                        query = '-- JSON 字段解析（假设有包含 JSON 的列）\nSELECT \n  id,\n  JSON_VALUE(jsonColumn, "$.name") AS name,\n  JSON_VALUE(jsonColumn, "$.address.city") AS city\nFROM filename.sheetname\nWHERE JSON_VALUE(jsonColumn, "$.age") > 30';
                        break;
                    case 4:
                        query = '-- 聚合查询\nSELECT \n  category,\n  COUNT(*) AS count,\n  SUM(amount) AS total,\n  AVG(amount) AS average\nFROM filename.sheetname\nGROUP BY category\nHAVING COUNT(*) > 5\nORDER BY total DESC';
                        break;
                }

                editor.setValue(query);
                editor.focus();
            }

            // 处理错误
            function handleError(error) {
                console.error(error);
                alert('发生错误：' + error);
            }

            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', function() {
                initEditor();
                loadSheets();

                // 等待短暂延迟后初始化模态框，确保DOM完全加载
                setTimeout(initModals, 500);

                // 加载查询历史（当切换到对应标签页时）
                const historyTabEl = document.getElementById('history-tab');
                if (historyTabEl) {
                    historyTabEl.addEventListener('click', loadQueryHistory);
                }

                // 加载模板（当切换到对应标签页时）
                const templatesTabEl = document.getElementById('templates-tab');
                if (templatesTabEl) {
                    templatesTabEl.addEventListener('click', refreshTemplates);
                }

                // 初始化公共模板功能
                initPublicTemplatesFeature();

                // 在页面加载后动态设置导航 URL
                const currentUrl = window.location.href;

                // 提取基础 URL（移除所有查询参数）
                const baseUrl = currentUrl.split('?')[0];

                // 设置导航链接
                const navLinks = document.querySelectorAll('[data-nav-link]');
                navLinks.forEach(link => {
                    const target = link.getAttribute('data-nav-link');
                    if (target === 'home') {
                        link.href = baseUrl;
                    } else {
                        link.href = `${baseUrl}?page=${target}`;
                    }

                    // 如果链接需要在新窗口打开
                    if (link.getAttribute('data-target') === '_blank') {
                        link.target = '_blank';
                    }
                });
            });

            // 过滤表列表
            function filterSheets() {
                const searchText = document.getElementById('sheetSearchInput').value.toLowerCase();
                const sheetNodes = document.querySelectorAll('.sheet-name');

                if (!searchText) {
                    // 如果搜索框为空，显示所有表
                    sheetNodes.forEach(node => {
                        node.parentElement.style.display = 'block';
                    });
                    return;
                }

                // 根据搜索文本过滤表
                sheetNodes.forEach(node => {
                    const sheetName = node.textContent.trim().toLowerCase();
                    if (sheetName.includes(searchText)) {
                        node.parentElement.style.display = 'block';
                    } else {
                        node.parentElement.style.display = 'none';
                    }
                });
            }
        </script>

        <!-- 添加模板相关的 JavaScript 代码 -->
        <script>
            // 模板功能相关变量和函数
            let templateModalInstance;
            let paramsModalInstance;
            let currentTemplateWithParams;

            // 初始化模态框函数
            function initModals() {
                const templateModalEl = document.getElementById('templateModal');
                const paramsModalEl = document.getElementById('paramsModal');

                if (templateModalEl && paramsModalEl) {
                    templateModalInstance = new bootstrap.Modal(templateModalEl);
                    paramsModalInstance = new bootstrap.Modal(paramsModalEl);
                    console.log('模态框初始化成功');
                } else {
                    console.error('模态框元素未找到', {
                        templateModalEl,
                        paramsModalEl
                    });
                }
            }

            // 打开保存模板对话框
            function saveTemplateModal() {
                const sql = editor.getValue().trim();

                // if (!sql || sql.startsWith('--')) {
                //     alert('请先输入有效的 SQL 查询');
                //     return;
                // }

                // 确保元素存在再设置值
                const templateNameEl = document.getElementById('templateName');
                const templateDescEl = document.getElementById('templateDescription');
                const previewSqlEl = document.getElementById('previewSql');
                const validationRulesEl = document.getElementById('templateValidationRules');

                if (!templateNameEl || !templateDescEl || !previewSqlEl || !validationRulesEl) {
                    console.error('模板表单元素未找到');
                    alert('表单加载错误，请刷新页面重试');
                    return;
                }

                templateNameEl.value = '';
                templateDescEl.value = '';
                previewSqlEl.textContent = sql;

                // 设置当前验证规则
                const currentValidationRules = document.getElementById('validationRules').value;
                validationRulesEl.value = currentValidationRules;

                if (!templateModalInstance) {
                    console.error('模态框实例未初始化');
                    initModals(); // 尝试重新初始化
                }

                if (templateModalInstance) {
                    templateModalInstance.show();
                } else {
                    alert('无法显示模板表单，请刷新页面重试');
                }
            }

            // 刷新模板列表
            function refreshTemplates() {
                const templateListEl = document.getElementById('templateList');
                templateListEl.innerHTML = '<div class="spinner"></div> 加载中...';

                google.script.run
                    .withSuccessHandler(displayTemplates)
                    .withFailureHandler(handleError)
                    .getSQLTemplatesForClient();
            }

            // 显示模板列表
            function displayTemplates(templates) {
                const templateListEl = document.getElementById('templateList');

                if (!templates || templates.length === 0) {
                    templateListEl.innerHTML = '<p>没有保存的模板</p>';
                    return;
                }

                let html = '';

                templates.forEach(template => {
                    const date = new Date(template.updated);
                    const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

                    // 显示是否有验证规则的标识
                    const hasValidation = template.validationRules &&
                        template.validationRules.length > 0;
                    const validationBadge = hasValidation ?
                        '<span class="badge bg-info ms-2" title="包含验证规则">验证</span>' : '';

                    html += `
                        <div class="query-history-item">
                            <div class="d-flex justify-content-between">
                                <strong class="template-name" onclick="loadTemplate('${template.name}')">
                                    ${template.name} ${validationBadge}
                                </strong>
                                <div>
                                    <button class="btn btn-sm btn-outline-info py-0 me-1" onclick="viewTemplateDetails('${template.name}')">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger py-0" onclick="deleteTemplate('${template.name}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="small text-muted">${template.description || '无描述'}</div>
                            <div class="history-timestamp">更新于: ${formattedDate}</div>
                        </div>
                    `;
                });

                templateListEl.innerHTML = html;
            }

            // 保存模板
            function saveTemplate() {
                const name = document.getElementById('templateName').value.trim();
                const description = document.getElementById('templateDescription').value.trim();
                const sql = editor.getValue().trim();

                // 新增：获取验证规则
                const validationRulesText = document.getElementById('templateValidationRules').value;
                const validationRules = validationRulesText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);

                if (!name) {
                    alert('请输入模板名称');
                    return;
                }

                if (!sql) {
                    alert('SQL 查询不能为空');
                    return;
                }

                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            templateModalInstance.hide();
                            alert(result.message);
                            refreshTemplates();
                        } else {
                            alert('保存失败: ' + (result.error || '未知错误'));
                        }
                    })
                    .withFailureHandler(handleError)
                    .saveSQLTemplateForClient(name, description, sql, validationRules);
            }

            // 加载模板
            function loadTemplate(name) {
                google.script.run
                    .withSuccessHandler(function(templates) {
                        const template = templates.find(t => t.name === name);

                        if (!template) {
                            alert('找不到模板: ' + name);
                            return;
                        }

                        // 检查模板中的参数
                        const params = extractTemplateParams(template.sql);

                        if (params.length > 0) {
                            // 有参数，显示参数输入对话框
                            showParamsInput(template, params);
                        } else {
                            // 无参数，直接应用模板
                            applyTemplate(template);
                        }
                    })
                    .withFailureHandler(handleError)
                    .getSQLTemplatesForClient();
            }

            // 提取模板中的参数
            function extractTemplateParams(sql) {
                const regex = /\{\{([^}]+)\}\}/g;
                const params = [];
                let match;

                while ((match = regex.exec(sql)) !== null) {
                    if (!params.includes(match[1])) {
                        params.push(match[1]);
                    }
                }

                return params;
            }

            // 显示参数输入对话框
            function showParamsInput(template, params) {
                const paramsFormEl = document.getElementById('paramsForm');
                let html = '<div class="mb-2">请输入以下参数值:</div>';

                params.forEach(param => {
                    html += `
                    <div class="mb-3">
                        <label class="form-label">${param}</label>
                        <input type="text" class="form-control param-input" data-param="${param}" placeholder="输入 ${param} 的值">
                    </div>
                `;
                });

                paramsFormEl.innerHTML = html;
                currentTemplateWithParams = template;
                paramsModalInstance.show();
            }

            // 应用带参数的模板
            function applyTemplateWithParams() {
                const inputs = document.querySelectorAll('.param-input');
                const params = {};

                // 收集参数值
                inputs.forEach(input => {
                    const param = input.getAttribute('data-param');
                    params[param] = input.value;
                });

                // 替换模板中的参数
                let sql = currentTemplateWithParams.sql;

                Object.keys(params).forEach(param => {
                    const regex = new RegExp('\\{\\{' + param + '\\}\\}', 'g');
                    sql = sql.replace(regex, params[param]);
                });

                // 应用到编辑器
                editor.setValue(sql);

                // 设置验证规则（如果有）
                if (currentTemplateWithParams.validationRules &&
                    currentTemplateWithParams.validationRules.length > 0) {
                    const rulesText = currentTemplateWithParams.validationRules.join('\n');
                    document.getElementById('validationRules').value = rulesText;
                }

                editor.focus();
                paramsModalInstance.hide();
            }

            // 删除模板
            function deleteTemplate(name) {
                if (confirm(`确定要删除模板 "${name}" 吗？`)) {
                    google.script.run
                        .withSuccessHandler(function(result) {
                            if (result.success) {
                                alert('模板已删除');
                                refreshTemplates();
                            } else {
                                alert('删除失败: ' + (result.error || '未知错误'));
                            }
                        })
                        .withFailureHandler(handleError)
                        .deleteSQLTemplateForClient(name);
                }
            }

            // 新增函数：应用模板（包括验证规则）
            function applyTemplate(template) {
                // 设置 SQL 查询
                editor.setValue(template.sql);

                // 如果模板有验证规则，设置验证规则
                if (template.validationRules && template.validationRules.length > 0) {
                    const rulesText = template.validationRules.join('\n');
                    document.getElementById('validationRules').value = rulesText;
                }

                editor.focus();
            }

            // 添加一个查看模板详情的功能
            function viewTemplateDetails(name) {
                google.script.run
                    .withSuccessHandler(function(templates) {
                            const template = templates.find(t => t.name === name);

                            if (!template) {
                                alert('找不到模板: ' + name);
                                return;
                            }

                            // 创建或获取模板详情模态框
                            let detailsModal = document.getElementById('templateDetailsModal');
                            if (!detailsModal) {
                                const modalHtml = `
                                <div class="modal fade" id="templateDetailsModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">模板详情</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body" id="templateDetailsContent">
                                                <!-- 内容将动态填充 -->
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                                <button type="button" class="btn btn-primary" onclick="loadTemplate('${name}')">使用此模板</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                                document.body.insertAdjacentHTML('beforeend', modalHtml);
                                detailsModal = document.getElementById('templateDetailsModal');
                            }

                            // 填充模板详情
                            const contentEl = document.getElementById('templateDetailsContent');
                            let html = `
                            <h4>${template.name}</h4>
                            <p>${template.description || '无描述'}</p>
                            
                            <h5>SQL 查询</h5>
                            <pre class="p-2 bg-light border rounded">${template.sql}</pre>
                        `;

                            // 添加验证规则部分
                            if (template.validationRules && template.validationRules.length > 0) {
                                html += `
                                <h5>验证规则</h5>
                                <ul class="list-group">
                                    ${template.validationRules.map(rule => 
                                        `<li class="list-group-item">${rule}</li>`).join('')}
                                </ul>
                            `;
                        } else {
                            html += `<p class="text-muted">此模板没有验证规则</p>`;
                        }
                        
                        contentEl.innerHTML = html;
                        
                        // 显示模态框
                        const bsModal = new bootstrap.Modal(detailsModal);
                        bsModal.show();
                    })
                    .withFailureHandler(handleError)
                    .getSQLTemplatesForClient();
            }
        </script>

        <!-- 动态创建模态框 -->
        <script>
            function createModals() {
                // 创建模板模态框
                const templateModalHtml = `
                <div class="modal fade" id="templateModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">保存 SQL 模板</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="templateForm">
                                    <div class="mb-3">
                                        <label for="templateName" class="form-label">模板名称</label>
                                        <input type="text" class="form-control" id="templateName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="templateDescription" class="form-label">描述 (可选)</label>
                                        <textarea class="form-control" id="templateDescription" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">SQL 查询</label>
                                        <pre id="previewSql" class="p-2 bg-light border rounded"></pre>
                                    </div>
                                    <div class="mb-3">
                                        <label for="templateValidationRules" class="form-label">验证规则 (可选)</label>
                                        <textarea class="form-control" id="templateValidationRules" rows="3" 
                                                  placeholder="每行一条规则，如：列名1 = 列名2"></textarea>
                                        <div class="form-text">用于检查查询结果的正确性，例如：id = ref_id</div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="saveTemplate()">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                document.body.insertAdjacentHTML('beforeend', templateModalHtml);

                // 创建参数模态框
                const paramsModalHtml = `
                <div class="modal fade" id="paramsModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">输入模板参数</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="paramsForm">
                                    <!-- 参数输入字段将在这里动态生成 -->
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="applyTemplateWithParams()">应用</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                document.body.insertAdjacentHTML('beforeend', paramsModalHtml);

                // 初始化模态框
                setTimeout(initModals, 100);
            }

            // 在加载时调用
            document.addEventListener('DOMContentLoaded', function() {
                createModals();
                // ...其他初始化
            });
        </script>

        <!-- 添加公共模板相关的 JavaScript 代码 -->
        <script>
            // 公共模板系统相关功能

            // 初始化公共模板功能
            function initPublicTemplatesFeature() {
                // 添加公共模板标签和面板
                updateTabsForPublicTemplates();

                // 创建相关模态框
                createPublicTemplateModals();

                // Get current user email
                google.script.run
                    .withSuccessHandler(function(email) {
                        document.getElementById('current-user-email').value = email;
                    })
                    .withFailureHandler(function(error) {
                        console.error('Failed to get user email:', error);
                    })
                    .getCurrentUserEmail(); // Need to implement this server-side function
            }

            // 在侧边栏导航中添加公共模板标签
            function updateTabsForPublicTemplates() {
                const sidebarTabs = document.getElementById('sidebarTabs');
                if (sidebarTabs) {
                    // 创建公共模板标签
                    const publicTemplatesTab = document.createElement('li');
                    publicTemplatesTab.className = 'nav-item';
                    publicTemplatesTab.role = 'presentation';
                    publicTemplatesTab.innerHTML = `
                      <button class="nav-link" id="public-templates-tab" data-bs-toggle="tab" 
                              data-bs-target="#public-templates-panel" type="button" role="tab">
                        公共模板
                      </button>
                    `;

                    // 将新标签添加到导航栏
                    sidebarTabs.appendChild(publicTemplatesTab);

                    // 创建公共模板内容区域
                    const sidebarContent = document.getElementById('sidebarContent');
                    const publicTemplatesPanel = document.createElement('div');
                    publicTemplatesPanel.className = 'tab-pane fade';
                    publicTemplatesPanel.id = 'public-templates-panel';
                    publicTemplatesPanel.role = 'tabpanel';
                    publicTemplatesPanel.innerHTML = `
                      <h5>公共模板库</h5>
                      <div id="publicTemplateList" class="sheet-list">
                        <p>点击加载公共模板...</p>
                      </div>
                      <div class="d-flex justify-content-between mt-2">
                        <button class="btn btn-sm btn-primary" onclick="submitPublicTemplateModal()">贡献模板</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadPublicTemplates()">刷新</button>
                      </div>
                    `;

                    sidebarContent.appendChild(publicTemplatesPanel);

                    // 添加点击事件处理函数
                    document.getElementById('public-templates-tab').addEventListener('click', loadPublicTemplates);
                }
            }

            // 创建所有公共模板相关的模态框
            function createPublicTemplateModals() {
                // 创建贡献模板模态框
                const submitModalHtml = `
                  <div class="modal fade" id="submitPublicTemplateModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">贡献模板到公共库</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <form id="submitPublicTemplateForm">
                            <div class="mb-3">
                              <label for="publicTemplateName" class="form-label">模板名称</label>
                              <input type="text" class="form-control" id="publicTemplateName" required>
                            </div>
                            <div class="mb-3">
                              <label for="publicTemplateDescription" class="form-label">描述</label>
                              <textarea class="form-control" id="publicTemplateDescription" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                              <label for="publicTemplateCategory" class="form-label">分类标签 (可选，用逗号分隔)</label>
                              <input type="text" class="form-control" id="publicTemplateCategory" placeholder="例如: 财务,报表,数据分析">
                            </div>
                            <div class="mb-3">
                              <label class="form-label">SQL 查询</label>
                              <pre id="publicPreviewSql" class="p-2 bg-light border rounded"></pre>
                            </div>
                            <div class="mb-3">
                              <label for="publicTemplateValidationRules" class="form-label">验证规则 (可选)</label>
                              <textarea class="form-control" id="publicTemplateValidationRules" rows="3" 
                                        placeholder="每行一条规则，如：列名1 = 列名2"></textarea>
                            </div>
                            <div class="form-text mb-3">
                              <i class="bi bi-info-circle"></i> 提交的模板将先经过审核，审核通过后才会公开显示。
                            </div>
                          </form>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                          <button type="button" class="btn btn-primary" onclick="submitPublicTemplate()">提交</button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;

                // 创建模板详情模态框
                const detailsModalHtml = `
                  <div class="modal fade" id="publicTemplateDetailsModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">公共模板详情</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <h4 id="publicTemplateName"></h4>
                          <p id="publicTemplateDescription"></p>
                          
                          <div class="row">
                            <div class="col-md-8">
                              <h5>SQL 查询</h5>
                              <pre id="publicTemplateSQL" class="p-2 bg-light border rounded" style="max-height: 200px; overflow: auto;"></pre>
                              
                              <h5>验证规则</h5>
                              <div id="publicTemplateRules"></div>
                            </div>
                            <div class="col-md-4">
                              <h5>模板信息</h5>
                              <div id="publicTemplateMetadata" class="small"></div>
                            </div>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-outline-primary" id="submitFeedbackBtn">
                            <i class="bi bi-star"></i> 提交反馈
                          </button>
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                          <button type="button" class="btn btn-success me-1" id="usePublicTemplateBtn">
                            <i class="bi bi-play-fill"></i> 直接使用
                          </button>
                          <button type="button" class="btn btn-primary" id="importPublicTemplateBtn">
                            <i class="bi bi-box-arrow-in-down"></i> 导入到个人模板
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;

                // 创建反馈模态框
                const feedbackModalHtml = `
                  <div class="modal fade" id="templateFeedbackModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">提交模板反馈</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <form id="templateFeedbackForm">
                            <input type="hidden" id="feedbackTemplateId">
                            <div class="mb-3">
                              <label class="form-label">评分</label>
                              <div class="rating-stars">
                                <div class="btn-group" role="group">
                                  <input type="radio" class="btn-check" name="templateRating" id="rating1" value="1" autocomplete="off">
                                  <label class="btn btn-outline-warning" for="rating1"><i class="bi bi-star-fill"></i></label>
                                  
                                  <input type="radio" class="btn-check" name="templateRating" id="rating2" value="2" autocomplete="off">
                                  <label class="btn btn-outline-warning" for="rating2"><i class="bi bi-star-fill"></i></label>
                                  
                                  <input type="radio" class="btn-check" name="templateRating" id="rating3" value="3" autocomplete="off" checked>
                                  <label class="btn btn-outline-warning" for="rating3"><i class="bi bi-star-fill"></i></label>
                                  
                                  <input type="radio" class="btn-check" name="templateRating" id="rating4" value="4" autocomplete="off">
                                  <label class="btn btn-outline-warning" for="rating4"><i class="bi bi-star-fill"></i></label>
                                  
                                  <input type="radio" class="btn-check" name="templateRating" id="rating5" value="5" autocomplete="off">
                                  <label class="btn btn-outline-warning" for="rating5"><i class="bi bi-star-fill"></i></label>
                                </div>
                              </div>
                            </div>
                            <div class="mb-3">
                              <label for="templateFeedbackComment" class="form-label">评论 (可选)</label>
                              <textarea class="form-control" id="templateFeedbackComment" rows="3" 
                                        placeholder="请分享您对此模板的看法..."></textarea>
                            </div>
                          </form>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                          <button type="button" class="btn btn-primary" onclick="submitFeedback()">提交反馈</button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;

                // 添加所有模态框到页面
                document.body.insertAdjacentHTML('beforeend', submitModalHtml);
                document.body.insertAdjacentHTML('beforeend', detailsModalHtml);
                document.body.insertAdjacentHTML('beforeend', feedbackModalHtml);
            }

            // 加载公共模板
            function loadPublicTemplates() {
                const publicTemplateListEl = document.getElementById('publicTemplateList');
                publicTemplateListEl.innerHTML = '<div class="spinner"></div> 加载中...';

                google.script.run
                    .withSuccessHandler(displayPublicTemplates)
                    .withFailureHandler(handleError)
                    .getPublicTemplatesForClient();
            }

            // 显示公共模板
            function displayPublicTemplates(templates) {
                const publicTemplateListEl = document.getElementById('publicTemplateList');

                if (!templates || templates.error) {
                    publicTemplateListEl.innerHTML = `<p>获取公共模板失败: ${templates.error || '未知错误'}</p>`;
                    return;
                }

                if (templates.length === 0) {
                    publicTemplateListEl.innerHTML = '<p>暂无公共模板</p>';
                    return;
                }

                let html = '';

                // 添加分类筛选
                const categories = [...new Set(templates.flatMap(t => t.tags))].filter(Boolean);
                if (categories.length > 0) {
                    html += `
                      <div class="mb-3">
                        <label class="form-label">按分类筛选:</label>
                        <select class="form-select form-select-sm" id="categoryFilter" onchange="filterPublicTemplates()">
                          <option value="">全部</option>
                          ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>
                      </div>
                    `;
                }
                
                html += '<div id="filteredTemplates">';
                
                // 模板列表
                templates.forEach(template => {
                    const date = new Date(template.updated);
                    const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                    
                    // 显示标签
                    const tagsHtml = template.tags && template.tags.length > 0 
                        ? template.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')
                        : '';
                    
                    // 显示是否有验证规则
                    const hasValidation = template.validationRules && template.validationRules.length > 0;
                    const validationBadge = hasValidation
                        ? '<span class="badge bg-info ms-1" title="包含验证规则">验证</span>'
                        : '';
                    
                    html += `
                      <div class="card mb-2 public-template-card" data-tags="${template.tags.join(',')}">
                        <div class="card-body p-2">
                          <div class="d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-1">
                              <span class="template-name" onclick="viewPublicTemplateDetails('${template.id}')">
                                ${template.name} ${validationBadge}
                              </span>
                            </h6>
                            <div>
                              <button class="btn btn-sm btn-outline-warning me-1" onclick="editPublicTemplateModal('${template.id}')">
                                <i class="bi bi-pencil"></i> 编辑
                              </button>
                              <button class="btn btn-sm btn-outline-success me-1" onclick="usePublicTemplateDirectly('${template.id}')">
                                <i class="bi bi-play-fill"></i> 直接使用
                              </button>
                              <button class="btn btn-sm btn-outline-primary" onclick="importPublicTemplate('${template.id}')">
                                <i class="bi bi-box-arrow-in-down"></i> 导入
                              </button>
                            </div>
                          </div>
                          <p class="card-text small mb-1">${template.description || '无描述'}</p>
                          <div class="d-flex justify-content-between align-items-center small text-muted">
                            <div>贡献者: ${template.contributor.split('@')[0]}</div>
                            <div>使用次数: ${template.usageCount}</div>
                          </div>
                          <div class="mt-1">
                            ${tagsHtml}
                          </div>
                        </div>
                      </div>
                    `;
                });
                
                html += '</div>';
                
                publicTemplateListEl.innerHTML = html;
            }
            
            // 筛选公共模板
            function filterPublicTemplates() {
                const categorySelect = document.getElementById('categoryFilter');
                if (!categorySelect) return;
                
                const selectedCategory = categorySelect.value;
                const templateCards = document.querySelectorAll('.public-template-card');
                
                templateCards.forEach(card => {
                    const cardTags = card.getAttribute('data-tags').split(',');
                    if (!selectedCategory || cardTags.includes(selectedCategory)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
            
            // 打开提交模板模态框
            function submitPublicTemplateModal() {
                const sql = editor.getValue().trim();
                
                // if (!sql || sql.startsWith('--')) {
                //     alert('请先输入有效的 SQL 查询');
                //     return;
                // }
                
                // 填充表单
                document.getElementById('publicTemplateName').value = '';
                document.getElementById('publicTemplateDescription').value = '';
                document.getElementById('publicTemplateCategory').value = '';
                document.getElementById('publicPreviewSql').textContent = sql;
                
                // 设置当前验证规则
                const currentValidationRules = document.getElementById('validationRules').value;
                document.getElementById('publicTemplateValidationRules').value = currentValidationRules;
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('submitPublicTemplateModal'));
                modal.show();
            }
            
            // 提交模板到公共库
            function submitPublicTemplate() {
                const name = document.getElementById('publicTemplateName').value.trim();
                const description = document.getElementById('publicTemplateDescription').value.trim();
                const category = document.getElementById('publicTemplateCategory').value.trim();
                const sql = editor.getValue().trim();
                
                // 获取验证规则
                const validationRulesText = document.getElementById('publicTemplateValidationRules').value;
                const validationRules = validationRulesText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                if (!name) {
                    alert('请输入模板名称');
                    return;
                }
                
                if (!sql) {
                    alert('SQL 查询不能为空');
                    return;
                }
                
                // 处理分类标签
                const categories = category.split(',').map(c => c.trim()).filter(Boolean);
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            bootstrap.Modal.getInstance(document.getElementById('submitPublicTemplateModal')).hide();
                            alert(result.message);
                            loadPublicTemplates(); // 刷新公共模板列表
                        } else {
                            alert('提交失败: ' + (result.error || '未知错误'));
                        }
                    })
                    .withFailureHandler(handleError)
                    .submitPublicTemplateForClient(name, description, sql, validationRules, categories.join(','));
            }
            
            // 导入公共模板
            function importPublicTemplate(templateId) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            alert(result.message);
                            refreshTemplates(); // 刷新个人模板列表
                        } else {
                            alert('导入失败: ' + (result.error || '未知错误'));
                        }
                    })
                    .withFailureHandler(handleError)
                    .importPublicTemplateForClient(templateId);
            }
            
            // 查看公共模板详情
            function viewPublicTemplateDetails(templateId) {
                google.script.run
                    .withSuccessHandler(function(templates) {
                        if (!templates || templates.error) {
                            alert('获取模板详情失败: ' + (templates.error || '未知错误'));
                            return;
                        }
                        
                        const template = templates.find(t => t.id === templateId);
                        if (!template) {
                            alert('找不到指定的模板');
                            return;
                        }
                        
                        // 填充模板详情
                        document.getElementById('publicTemplateName').textContent = template.name;
                        document.getElementById('publicTemplateDescription').textContent = template.description || '无描述';
                        document.getElementById('publicTemplateSQL').textContent = template.sql;
                        
                        // 显示验证规则
                        const rulesEl = document.getElementById('publicTemplateRules');
                        if (template.validationRules && template.validationRules.length > 0) {
                            let rulesHtml = '<ul class="list-group">';
                            template.validationRules.forEach(rule => {
                                rulesHtml += `<li class="list-group-item">${rule}</li>`;
                            });
                            rulesHtml += '</ul>';
                            rulesEl.innerHTML = rulesHtml;
                        } else {
                            rulesEl.innerHTML = '<p class="text-muted">此模板没有验证规则</p>';
                        }
                        
                        // 显示模板元数据
                        document.getElementById('publicTemplateMetadata').innerHTML = `
                          <div><strong>贡献者:</strong> ${template.contributor}</div>
                          <div><strong>创建时间:</strong> ${new Date(template.created).toLocaleString()}</div>
                          <div><strong>更新时间:</strong> ${new Date(template.updated).toLocaleString()}</div>
                          <div><strong>使用次数:</strong> ${template.usageCount}</div>
                        `;
                        
                        // 设置直接使用按钮的事件处理
                        document.getElementById('usePublicTemplateBtn').onclick = function() {
                            usePublicTemplateDirectly(templateId);
                            bootstrap.Modal.getInstance(document.getElementById('publicTemplateDetailsModal')).hide();
                        };
                        
                        // 设置导入按钮的事件处理
                        document.getElementById('importPublicTemplateBtn').onclick = function() {
                            importPublicTemplate(templateId);
                            bootstrap.Modal.getInstance(document.getElementById('publicTemplateDetailsModal')).hide();
                        };
                        
                        // 设置反馈按钮的事件处理
                        document.getElementById('submitFeedbackBtn').onclick = function() {
                            showTemplateFeedbackModal(templateId);
                        };
                        
                        // 显示模态框
                        const modal = new bootstrap.Modal(document.getElementById('publicTemplateDetailsModal'));
                        modal.show();
                    })
                    .withFailureHandler(handleError)
                    .getPublicTemplatesForClient();
            }
            
            // 显示模板反馈模态框
            function showTemplateFeedbackModal(templateId) {
                // 隐藏当前的详情模态框
                bootstrap.Modal.getInstance(document.getElementById('publicTemplateDetailsModal')).hide();
                
                // 设置模板ID
                document.getElementById('feedbackTemplateId').value = templateId;
                
                // 重置表单
                document.getElementById('templateFeedbackComment').value = '';
                document.getElementById('rating3').checked = true; // 默认3星
                
                // 显示反馈模态框
                const modal = new bootstrap.Modal(document.getElementById('templateFeedbackModal'));
                modal.show();
            }
            
            // 提交模板反馈
            function submitFeedback() {
                const templateId = document.getElementById('feedbackTemplateId').value;
                const comment = document.getElementById('templateFeedbackComment').value.trim();
                
                // 获取评分
                let rating = 3; // 默认值
                const ratingInputs = document.querySelectorAll('input[name="templateRating"]');
                for (const input of ratingInputs) {
                    if (input.checked) {
                        rating = parseInt(input.value);
                        break;
                    }
                }
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            bootstrap.Modal.getInstance(document.getElementById('templateFeedbackModal')).hide();
                            alert(result.message);
                        } else {
                            alert('提交反馈失败: ' + (result.error || '未知错误'));
                        }
                    })
                    .withFailureHandler(handleError)
                    .submitTemplateFeedbackForClient(templateId, rating, comment);
            }

            // 添加直接使用公共模板的函数
            function usePublicTemplateDirectly(templateId) {
                google.script.run
                    .withSuccessHandler(function(templates) {
                        if (!templates || templates.error) {
                            alert('获取模板详情失败: ' + (templates.error || '未知错误'));
                            return;
                        }
                        
                        const template = templates.find(t => t.id === templateId);
                        if (!template) {
                            alert('找不到指定的模板');
                            return;
                        }
                        
                        // 检查模板中的参数
                        const params = extractTemplateParams(template.sql);
                        
                        if (params.length > 0) {
                            // 有参数，显示参数输入对话框
                            currentTemplateWithParams = template;
                            showParamsInput(template, params);
                        } else {
                            // 无参数，直接应用模板
                            applyTemplate(template);
                        }
                        
                        // 增加使用计数（可选）
                        incrementTemplateUsageCount(templateId);
                    })
                    .withFailureHandler(handleError)
                    .getPublicTemplatesForClient();
            }

            // 增加模板使用计数的辅助函数
            function incrementTemplateUsageCount(templateId) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        // 静默更新，不需要用户反馈
                        if (result && result.success) {
                            console.log('模板使用计数已更新');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('更新模板使用计数失败:', error);
                    })
                    .incrementTemplateUsageForClient(templateId);
            }

            // Add this function to handle the edit modal
            function editPublicTemplateModal(templateId) {
                google.script.run
                    .withSuccessHandler(function(templates) {
                        if (!templates || templates.error) {
                            alert('获取模板详情失败: ' + (templates.error || '未知错误'));
                            return;
                        }
                        
                        const template = templates.find(t => t.id === templateId);
                        if (!template) {
                            alert('找不到指定的模板');
                            return;
                        }
                        
                        // Fill the submit modal with existing template data
                        document.getElementById('publicTemplateName').value = template.name;
                        document.getElementById('publicTemplateDescription').value = template.description || '';
                        document.getElementById('publicTemplateCategory').value = template.tags ? template.tags.join(',') : '';
                        document.getElementById('publicPreviewSql').textContent = template.sql;
                        
                        // Set validation rules
                        if (template.validationRules && template.validationRules.length > 0) {
                            document.getElementById('publicTemplateValidationRules').value = template.validationRules.join('\n');
                        } else {
                            document.getElementById('publicTemplateValidationRules').value = '';
                        }
                        
                        // Add a hidden field to store the template ID for update
                        let hiddenIdField = document.getElementById('publicTemplateId');
                        if (!hiddenIdField) {
                            hiddenIdField = document.createElement('input');
                            hiddenIdField.type = 'hidden';
                            hiddenIdField.id = 'publicTemplateId';
                            document.getElementById('submitPublicTemplateForm').appendChild(hiddenIdField);
                        }
                        hiddenIdField.value = templateId;
                        
                        // Change the submit button text to indicate update
                        const submitBtn = document.querySelector('#submitPublicTemplateModal .modal-footer .btn-primary');
                        submitBtn.textContent = '更新模板';
                        submitBtn.onclick = updatePublicTemplate;
                        
                        // Show the modal
                        const modal = new bootstrap.Modal(document.getElementById('submitPublicTemplateModal'));
                        modal.show();
                    })
                    .withFailureHandler(handleError)
                    .getPublicTemplatesForClient();
            }

            // Add this function to handle the template update
            function updatePublicTemplate() {
                const templateId = document.getElementById('publicTemplateId').value;
                const name = document.getElementById('publicTemplateName').value.trim();
                const description = document.getElementById('publicTemplateDescription').value.trim();
                const category = document.getElementById('publicTemplateCategory').value.trim();
                const sql = document.getElementById('publicPreviewSql').textContent;
                
                // Get validation rules
                const validationRulesText = document.getElementById('publicTemplateValidationRules').value;
                const validationRules = validationRulesText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                if (!name) {
                    alert('请输入模板名称');
                    return;
                }
                
                if (!sql) {
                    alert('SQL 查询不能为空');
                    return;
                }
                
                // Process category tags
                const categories = category.split(',').map(c => c.trim()).filter(Boolean);
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            bootstrap.Modal.getInstance(document.getElementById('submitPublicTemplateModal')).hide();
                            alert(result.message);
                            loadPublicTemplates(); // Refresh the public templates list
                            
                            // Reset the submit button to its default state for new submissions
                            const submitBtn = document.querySelector('#submitPublicTemplateModal .modal-footer .btn-primary');
                            submitBtn.textContent = '提交';
                            submitBtn.onclick = submitPublicTemplate;
                        } else {
                            alert('更新失败: ' + (result.error || '未知错误'));
                        }
                    })
                    .withFailureHandler(handleError)
                    .updatePublicTemplateForClient(templateId, name, description, sql, validationRules, categories.join(','));
            }
        </script>
    </div>
</body>

</html>